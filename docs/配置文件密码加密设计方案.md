# 配置文件密码加密设计方案

## 1. 概述

本设计方案基于现有的密码加密技术方案，实现配置文件中敏感信息的加密存储和解密使用，确保生产环境中敏感信息的安全性。

## 2. 需要加密的配置项

根据分析，以下配置项需要进行加密：

| 配置类型 | 配置键示例 | 所在文件 | 优先级 |
|---------|-----------|---------|-------|
| 数据库密码 | spring.datasource.password | application-dev.yml/application-prod.yml | 高 |
| Redis密码 | spring.redis.password | application-dev.yml/application-prod.yml | 高 |
| JWT密钥 | spring.jwt.secret | application.yml/application-prod.yml | 高 |
| 安全Token密钥 | app.security.token.secret | application.yml/application-prod.yml | 高 |

## 3. 加密算法选择

采用以下加密算法组合：

- **主加密算法**：AES-256-GCM（GCM模式提供认证加密功能）
- **密钥派生函数**：PBKDF2（防止暴力破解）
- **密钥大小**：256位（军事级安全）

## 4. 密钥管理方案

### 4.1 密钥存储方式

- **开发环境**：密钥可存储在环境变量或配置文件中（非明文）
- **测试/生产环境**：密钥必须存储在环境变量中，禁止硬编码

### 4.2 密钥格式

- 使用Base64编码的随机密钥
- 密钥长度：32字节（256位）

### 4.3 密钥轮换机制

- 支持配置多版本密钥，实现零停机密钥更新
- 密钥版本通过前缀标识

## 5. 加密格式定义

### 5.1 加密内容标识格式

使用`ENC()`格式标识加密内容：
```
spring.datasource.password=ENC(base64_encoded_encrypted_data)
```

### 5.2 加密数据结构

加密后的数据包含：
- 版本信息（1字节）
- 随机IV（12字节）
- 加密内容
- 认证标签（16字节）
- 所有数据使用Base64编码

## 6. 解密过程设计

### 6.1 配置加载流程

1. 应用启动时加载配置文件
2. 检测配置值是否以`ENC(`开头并以`)`结尾
3. 提取加密数据并进行解密
4. 将解密后的值替换到配置中

### 6.2 性能优化

- 使用缓存机制缓存解密结果
- 避免重复解密相同的配置项

## 7. 集成方式

### 7.1 配置属性处理器

实现Spring的`EnvironmentPostProcessor`接口，在环境初始化阶段进行解密处理。

### 7.2 自定义属性源

创建自定义的`PropertySource`，支持自动解密加密的属性值。

## 8. 安全保障措施

### 8.1 防泄露措施

- 禁止在日志中输出解密后的明文
- 加密过程不涉及网络传输

### 8.2 异常处理

- 解密失败时提供明确的错误信息
- 支持解密失败策略配置（抛出异常或使用默认值）

### 8.3 审计日志

记录配置解密操作，但不记录明文内容。

## 9. 工具类设计

### 9.1 EncryptUtil

提供加密、解密、密钥生成等核心功能。

### 9.2 命令行工具

提供命令行工具用于生成密钥和加密配置值。

## 10. 兼容性考虑

- 支持现有的配置管理系统
- 兼容不同环境（开发、测试、生产）
- 支持配置中心集成

## 11. 实施步骤

1. 创建加密工具类
2. 实现配置解密处理器
3. 编写密钥管理逻辑
4. 集成到Spring Boot应用
5. 编写文档和使用说明
6. 部署和验证

本设计方案遵循现有的密码加密技术方案，确保与系统的其他安全功能保持一致。