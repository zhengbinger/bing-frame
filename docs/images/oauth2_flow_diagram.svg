<svg width="1400" height="1000" xmlns="http://www.w3.org/2000/svg">
  <defs>
    <style>
      .title { font-family: Arial, sans-serif; font-size: 18px; font-weight: bold; fill: #2c3e50; }
      .subtitle { font-family: Arial, sans-serif; font-size: 14px; font-weight: bold; fill: #34495e; }
      .text { font-family: Arial, sans-serif; font-size: 12px; fill: #2c3e50; }
      .step { font-family: Arial, sans-serif; font-size: 10px; fill: white; font-weight: bold; }
      .user { fill: #3498db; stroke: #2980b9; stroke-width: 2px; }
      .system { fill: #2ecc71; stroke: #27ae60; stroke-width: 2px; }
      .third-party { fill: #e74c3c; stroke: #c0392b; stroke-width: 2px; }
      .process { fill: #f39c12; stroke: #e67e22; stroke-width: 2px; }
    </style>
    <marker id="arrowhead" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
      <polygon points="0 0, 10 3.5, 0 7" fill="#34495e"/>
    </marker>
  </defs>
  
  <!-- 标题 -->
  <text x="700" y="30" class="title" text-anchor="middle">第三方登录完整流程图</text>
  
  <!-- 用户区域 -->
  <g id="user">
    <rect x="50" y="100" width="200" height="80" class="user" rx="10"/>
    <text x="150" y="135" class="subtitle" text-anchor="middle">用户</text>
    <text x="150" y="155" class="text" text-anchor="middle">点击第三方登录按钮</text>
  </g>
  
  <!-- 前端应用 -->
  <g id="frontend">
    <rect x="350" y="100" width="200" height="80" class="system" rx="10"/>
    <text x="450" y="130" class="subtitle" text-anchor="middle">前端应用</text>
    <text x="450" y="150" class="text" text-anchor="middle">生成state参数</text>
    <text x="450" y="165" class="text" text-anchor="middle">跳转到授权页面</text>
  </g>
  
  <!-- 第三方平台 -->
  <g id="third-party-system">
    <rect x="650" y="100" width="200" height="80" class="third-party" rx="10"/>
    <text x="750" y="130" class="subtitle" text-anchor="middle">第三方平台</text>
    <text x="750" y="150" class="text" text-anchor="middle">展示授权页面</text>
    <text x="750" y="165" class="text" text-anchor="middle">用户确认授权</text>
  </g>
  
  <!-- 我们的后端服务 -->
  <g id="our-backend">
    <rect x="950" y="100" width="200" height="80" class="system" rx="10"/>
    <text x="1050" y="130" class="subtitle" text-anchor="middle">我们的后端服务</text>
    <text x="1050" y="150" class="text" text-anchor="middle">等待授权回调</text>
  </g>
  
  <!-- 流程步骤 -->
  <g id="steps">
    <!-- 步骤1: 生成授权URL -->
    <rect x="350" y="220" width="200" height="60" class="process" rx="5"/>
    <text x="450" y="245" class="step" text-anchor="middle">步骤1</text>
    <text x="450" y="260" class="text" text-anchor="middle">生成授权URL</text>
    <text x="450" y="275" class="text" text-anchor="middle">包含client_id、redirect_uri、state</text>
    
    <!-- 步骤2: 保存state -->
    <rect x="950" y="220" width="200" height="60" class="process" rx="5"/>
    <text x="1050" y="245" class="step" text-anchor="middle">步骤2</text>
    <text x="1050" y="260" class="text" text-anchor="middle">保存state到Redis</text>
    <text x="1050" y="275" class="text" text-anchor="middle">用于后续验证</text>
    
    <!-- 步骤3: 用户授权 -->
    <rect x="650" y="320" width="200" height="60" class="process" rx="5"/>
    <text x="750" y="345" class="step" text-anchor="middle">步骤3</text>
    <text x="750" y="360" class="text" text-anchor="middle">用户确认授权</text>
    <text x="750" y="375" class="text" text-anchor="middle">平台返回授权码</text>
    
    <!-- 步骤4: 回调处理 -->
    <rect x="950" y="420" width="200" height="60" class="process" rx="5"/>
    <text x="1050" y="445" class="step" text-anchor="middle">步骤4</text>
    <text x="1050" y="460" class="text" text-anchor="middle">处理授权回调</text>
    <text x="1050" y="475" class="text" text-anchor="middle">验证state参数</text>
    
    <!-- 步骤5: 交换令牌 -->
    <rect x="950" y="520" width="200" height="60" class="process" rx="5"/>
    <text x="1050" y="545" class="step" text-anchor="middle">步骤5</text>
    <text x="1050" y="560" class="text" text-anchor="middle">交换访问令牌</text>
    <text x="1050" y="575" class="text" text-anchor="middle">POST到token_url</text>
    
    <!-- 步骤6: 获取用户信息 -->
    <rect x="950" y="620" width="200" height="60" class="process" rx="5"/>
    <text x="1050" y="645" class="step" text-anchor="middle">步骤6</text>
    <text x="1050" y="660" class="text" text-anchor="middle">获取用户信息</text>
    <text x="1050" y="675" class="text" text-anchor="middle">调用用户信息API</text>
    
    <!-- 步骤7: 账号绑定处理 -->
    <rect x="650" y="720" width="200" height="80" class="process" rx="5"/>
    <text x="750" y="745" class="step" text-anchor="middle">步骤7</text>
    <text x="750" y="760" class="text" text-anchor="middle">账号绑定处理</text>
    <text x="750" y="775" class="text" text-anchor="middle">• 检查是否已存在用户</text>
    <text x="750" y="790" class="text" text-anchor="middle">• 创建或绑定账号</text>
    
    <!-- 步骤8: 生成JWT令牌 -->
    <rect x="350" y="720" width="200" height="80" class="process" rx="5"/>
    <text x="450" y="745" class="step" text-anchor="middle">步骤8</text>
    <text x="450" y="760" class="text" text-anchor="middle">生成JWT令牌</text>
    <text x="450" y="775" class="text" text-anchor="middle">• 生成Access Token</text>
    <text x="450" y="790" class="text" text-anchor="middle">• 生成Refresh Token</text>
    
    <!-- 步骤9: 返回登录结果 -->
    <rect x="50" y="720" width="200" height="80" class="process" rx="5"/>
    <text x="150" y="745" class="step" text-anchor="middle">步骤9</text>
    <text x="150" y="760" class="text" text-anchor="middle">返回登录结果</text>
    <text x="150" y="775" class="text" text-anchor="middle">• JWT令牌</text>
    <text x="150" y="790" class="text" text-anchor="middle">• 用户信息</text>
  </g>
  
  <!-- 连接线 -->
  <g id="connections">
    <!-- 用户到前端 -->
    <line x1="250" y1="140" x2="350" y2="140" stroke="#3498db" stroke-width="3" marker-end="url(#arrowhead)"/>
    <text x="300" y="130" class="text" text-anchor="middle">1. 点击登录</text>
    
    <!-- 前端到第三方 -->
    <line x1="550" y1="140" x2="650" y2="140" stroke="#e74c3c" stroke-width="3" marker-end="url(#arrowhead)"/>
    <text x="600" y="130" class="text" text-anchor="middle">2. 跳转授权页面</text>
    
    <!-- 第三方到后端 -->
    <line x1="850" y1="140" x2="950" y2="140" stroke="#2ecc71" stroke-width="3" marker-end="url(#arrowhead)"/>
    <text x="900" y="130" class="text" text-anchor="middle">3. 授权回调</text>
    
    <!-- 步骤间连接 -->
    <line x1="450" y1="180" x2="450" y2="220" stroke="#f39c12" stroke-width="2" marker-end="url(#arrowhead)"/>
    <line x1="1050" y1="180" x2="1050" y2="220" stroke="#f39c12" stroke-width="2" marker-end="url(#arrowhead)"/>
    <line x1="850" y1="180" x2="850" y2="320" stroke="#f39c12" stroke-width="2" marker-end="url(#arrowhead)"/>
    <line x1="1050" y1="280" x2="1050" y2="420" stroke="#f39c12" stroke-width="2" marker-end="url(#arrowhead)"/>
    <line x1="1050" y1="480" x2="1050" y2="520" stroke="#f39c12" stroke-width="2" marker-end="url(#arrowhead)"/>
    <line x1="1050" y1="580" x2="1050" y2="620" stroke="#f39c12" stroke-width="2" marker-end="url(#arrowhead)"/>
    <line x1="950" y1="650" x2="850" y2="680" stroke="#f39c12" stroke-width="2" marker-end="url(#arrowhead)"/>
    <line x1="650" y1="760" x2="550" y2="760" stroke="#f39c12" stroke-width="2" marker-end="url(#arrowhead)"/>
    <line x1="350" y1="760" x2="250" y2="760" stroke="#f39c12" stroke-width="2" marker-end="url(#arrowhead)"/>
    
    <!-- 返回流程 -->
    <line x1="250" y1="760" x2="250" y2="450" stroke="#e74c3c" stroke-width="2" stroke-dasharray="5,5" marker-end="url(#arrowhead)"/>
    <line x1="250" y1="450" x2="250" y2="180" stroke="#e74c3c" stroke-width="2" stroke-dasharray="5,5" marker-end="url(#arrowhead)"/>
  </g>
  
  <!-- 数据库操作 -->
  <g id="database-ops">
    <!-- Redis操作 -->
    <rect x="1200" y="200" width="150" height="60" fill="#f1c40f" stroke="#f39c12" stroke-width="2" rx="5"/>
    <text x="1275" y="220" class="text" text-anchor="middle">Redis操作</text>
    <text x="1275" y="235" class="text" text-anchor="middle">• 保存state参数</text>
    <text x="1275" y="250" class="text" text-anchor="middle">• 存储临时令牌</text>
    
    <!-- 数据库操作 -->
    <rect x="1200" y="700" width="150" height="80" fill="#9b59b6" stroke="#8e44ad" stroke-width="2" rx="5"/>
    <text x="1275" y="725" class="text" text-anchor="middle">数据库操作</text>
    <text x="1275" y="740" class="text" text-anchor="middle">• 查找/创建用户</text>
    <text x="1275" y="755" class="text" text-anchor="middle">• 绑定第三方账号</text>
    <text x="1275" y="770" class="text" text-anchor="middle">• 记录登录日志</text>
    
    <!-- 连接数据库 -->
    <line x1="1050" y1="250" x2="1200" y2="230" stroke="#f39c12" stroke-width="2" stroke-dasharray="3,3" marker-end="url(#arrowhead)"/>
    <line x1="850" y1="760" x2="1200" y2="740" stroke="#9b59b6" stroke-width="2" stroke-dasharray="3,3" marker-end="url(#arrowhead)"/>
  </g>
  
  <!-- 安全检查点 -->
  <g id="security">
    <rect x="450" y="420" width="120" height="40" fill="#e74c3c" stroke="#c0392b" stroke-width="2" rx="20"/>
    <text x="510" y="435" class="text" text-anchor="middle" fill="white">安全检查</text>
    <text x="510" y="450" class="text" text-anchor="middle" fill="white" font-size="10">state验证</text>
    
    <rect x="650" y="520" width="120" height="40" fill="#e74c3c" stroke="#c0392b" stroke-width="2" rx="20"/>
    <text x="710" y="535" class="text" text-anchor="middle" fill="white">安全检查</text>
    <text x="710" y="550" class="text" text-anchor="middle" fill="white" font-size="10">token验证</text>
    
    <rect x="250" y="520" width="120" height="40" fill="#e74c3c" stroke="#c0392b" stroke-width="2" rx="20"/>
    <text x="310" y="535" class="text" text-anchor="middle" fill="white">安全检查</text>
    <text x="310" y="550" class="text" text-anchor="middle" fill="white" font-size="10">用户验证</text>
  </g>
  
  <!-- 图例 -->
  <g id="legend">
    <text x="50" y="880" class="subtitle">流程图例</text>
    
    <rect x="50" y="900" width="20" height="15" class="user"/>
    <text x="80" y="912" class="text">用户操作</text>
    
    <rect x="200" y="900" width="20" height="15" class="system"/>
    <text x="230" y="912" class="text">我们的系统</text>
    
    <rect x="350" y="900" width="20" height="15" class="third-party"/>
    <text x="380" y="912" class="text">第三方平台</text>
    
    <rect x="500" y="900" width="20" height="15" class="process"/>
    <text x="530" y="912" class="text">处理步骤</text>
    
    <rect x="650" y="900" width="20" height="15" fill="#e74c3c"/>
    <text x="680" y="912" class="text">安全检查</text>
    
    <line x1="50" y1="940" x2="120" y2="940" stroke="#34495e" stroke-width="3" marker-end="url(#arrowhead)"/>
    <text x="130" y="945" class="text">→ 正常流程</text>
    
    <line x1="250" y1="940" x2="320" y2="940" stroke="#e74c3c" stroke-width="3" stroke-dasharray="5,5" marker-end="url(#arrowhead)"/>
    <text x="330" y="945" class="text">→ 返回流程</text>
    
    <line x1="450" y1="940" x2="520" y2="940" stroke="#f39c12" stroke-width="2" stroke-dasharray="3,3" marker-end="url(#arrowhead)"/>
    <text x="530" y="945" class="text">→ 数据库操作</text>
  </g>
</svg>